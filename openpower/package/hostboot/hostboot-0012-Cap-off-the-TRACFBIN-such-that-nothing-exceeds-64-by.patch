From 22c58d6a7d3e6d69294aa16c9b0fa354ae9cf861 Mon Sep 17 00:00:00 2001
From: Elizabeth Liner <eliner@us.ibm.com>
Date: Mon, 30 Mar 2015 12:41:45 -0500
Subject: [PATCH 4/5] Cap off the TRACFBIN such that nothing exceeds 64 bytes

Change-Id: If8f08d1602b4437aa0e72e6d2e8d99ca615a2c77
(cherry picked from commit cb2ea9c1b5d1906e0f58eda347367c648c18809a)
---
 src/include/usr/trace/interface.H | 16 +++++++++++-----
 src/include/usr/trace/trace.H     |  2 ++
 2 files changed, 13 insertions(+), 5 deletions(-)

diff --git a/src/include/usr/trace/interface.H b/src/include/usr/trace/interface.H
index 3ef8575..d02db76 100644
--- a/src/include/usr/trace/interface.H
+++ b/src/include/usr/trace/interface.H
@@ -218,13 +218,19 @@ const uint32_t TRACE_FIELD   = 0;       //Indicates trace is field
 */
 #define TRACFBIN(des,printf_string,address,len) \
     { \
+        uint16_t l_length = len; \
+        if(len > MAX_WORKING_TRACBIN_SIZE) \
+        { \
+            l_length = MAX_WORKING_TRACBIN_SIZE; \
+            TRACFCOMP(des,"Shrinking to max size in TRACFBIN"); \
+        } \
         __TRACE_HASH_STRUCTURES(printf_string); \
         TRACE::trace_adal_write_bin((des), \
-                                    &__traceData_codeInfo, \
-                                    __LINE__, \
-                                    address, \
-                                    len, \
-                                    TRACE_FIELD); \
+                                &__traceData_codeInfo, \
+                                __LINE__, \
+                                address, \
+                                l_length, \
+                                TRACE_FIELD); \
     }
 
 /**
diff --git a/src/include/usr/trace/trace.H b/src/include/usr/trace/trace.H
index fdcce88..e969487 100644
--- a/src/include/usr/trace/trace.H
+++ b/src/include/usr/trace/trace.H
@@ -42,6 +42,8 @@ const uint32_t TRACE_DEBUG_OFF   = 0;       //< Set to this when debug trace off
 const uint32_t TRAC_COMP_SIZE    = 16;      //< Max component name size
 const uint32_t TRAC_MAX_ARGS     = 9;       //< Max number of arguments in trace
 
+const uint16_t MAX_WORKING_TRACBIN_SIZE = 64; //< Max working tracBin size
+
 typedef uint32_t trace_hash_val;    //< Hash values are 32 bits.
 
 
-- 
1.8.2.2

